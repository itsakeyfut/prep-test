# Nested Recursion（入れ子再帰）

## ✅ 概要

再帰呼び出しの引数がさらに再帰関数を呼んでいるという、再帰の中に再帰があるパターンです。
いわば「再帰のネスト」です。

## 📘 例：マッカーシー 91 関数（McCarthy 91 function）

これは最も有名な入れ子再帰の例です。

```rs
fn mc91(n: i32) -> i32 {
    if n > 100 {
        n - 10
    } else {
        mc91(mc91(n + 11))
    }
}

fn main() {
    for i in 90..=110 {
        println!("mc91({}) = {}", i, mc91(i));
    }
}
```

## 🧠 結果

```
mc91(90) = 91
mc91(91) = 91
mc91(92) = 91
mc91(93) = 91
mc91(94) = 91
mc91(95) = 91
mc91(96) = 91
mc91(97) = 91
mc91(98) = 91
mc91(99) = 91
mc91(100) = 91
mc91(101) = 91
mc91(102) = 92
mc91(103) = 93
mc91(104) = 94
mc91(105) = 95
mc91(106) = 96
mc91(107) = 97
mc91(108) = 98
mc91(109) = 99
mc91(110) = 100
```

## 🤔 解説

- `mc91(n)` は `n > 100` のときだけ直ちに値を返す。
- それ以外は `mc91(mc91(n + 11))` という入れ子再帰。
- 結果として、`n <= 100` のときはすべて `91` になるという性質を持つ。

## 🧠 設計視点

- 通常の再帰より再帰深度が深くなりやすく、追跡が難しい。
- メモ化（メモリを使って途中結果を保存）や DP では扱いにくい。
- 実用ではあまり登場しないが、言語設計・理論計算機科学の題材として重要。

## 🧪 演習（やや難）

入れ子再帰を模倣した式の評価器を作るのも一つのアイデアです。

### 🔧 演習 ①：マッカーシー 91 の仕組みを可視化せよ（再帰の深さと戻り値）

```rs
fn mc91(n: i32, depth: usize) -> i32 {
    println!("{:indent$}mc91({})", "", n, indent = depth * 2);
    if n > 100 {
        println!("{:indent$}mc91({})", "", n - 10, indent = depth * 2);
        n - 10
    } else {
        let result = mc91(mc91(n + 11, depth + 1), depth + 1);
        println!("{:indent$}mc91({})", "", n, indent = depth * 2);
        result
    }
}

fn main() {
    println!("Result: {}", mc91(87, 0));
}
```

```
mc91(87)
  mc91(98)
    mc91(109)
    mc91(99)
    mc91(99)
      mc91(110)
      mc91(100)
      mc91(100)
        mc91(111)
        mc91(101)
        mc91(101)
        mc91(91)
      mc91(100)
    mc91(99)
  mc91(98)
  mc91(91)
    mc91(102)
    mc91(92)
    mc91(92)
      mc91(103)
      mc91(93)
      mc91(93)
        mc91(104)
        mc91(94)
        mc91(94)
          mc91(105)
          mc91(95)
          mc91(95)
            mc91(106)
            mc91(96)
            mc91(96)
              mc91(107)
              mc91(97)
              mc91(97)
                mc91(108)
                mc91(98)
                mc91(98)
                  mc91(109)
                  mc91(99)
                  mc91(99)
                    mc91(110)
                    mc91(100)
                    mc91(100)
                      mc91(111)
                      mc91(101)
                      mc91(101)
                      mc91(91)
                    mc91(100)
                  mc91(99)
                mc91(98)
              mc91(97)
            mc91(96)
          mc91(95)
        mc91(94)
      mc91(93)
    mc91(92)
  mc91(91)
mc91(87)
Result: 91
```

### ✅ 目的：

- 入れ子再帰でどう再帰がネストされていくかをログで確認

### 🔧 演習 ②：mc91 関数の出力を全範囲で確認せよ

```rs
fn mc91(n: i32) -> i32 {
    if n > 100 {
        n - 10
    } else {
        mc91(mc91(n + 11))
    }
}

fn main() {
    for i in 80..=120 {
        println!("mc91({}) = {}", i, mc91(i));
    }
}
```

```
mc91(80) = 91
mc91(81) = 91
mc91(82) = 91
mc91(83) = 91
mc91(84) = 91
mc91(85) = 91
mc91(86) = 91
mc91(87) = 91
mc91(88) = 91
mc91(89) = 91
mc91(90) = 91
mc91(91) = 91
mc91(92) = 91
mc91(93) = 91
mc91(94) = 91
mc91(95) = 91
mc91(96) = 91
mc91(97) = 91
mc91(98) = 91
mc91(99) = 91
mc91(100) = 91
mc91(101) = 91
mc91(102) = 92
mc91(103) = 93
mc91(104) = 94
mc91(105) = 95
mc91(106) = 96
mc91(107) = 97
mc91(108) = 98
mc91(109) = 99
mc91(110) = 100
mc91(111) = 101
mc91(112) = 102
mc91(113) = 103
mc91(114) = 104
mc91(115) = 105
mc91(116) = 106
mc91(117) = 107
mc91(118) = 108
mc91(119) = 109
mc91(120) = 110
```

### ✅ 目的：

- `n <= 100` ならば結果が `91` になるという性質の検証。

### 🔧 演習 ③：マッカーシー 91 を Rust でクロージャ化してみる（高階関数）

```rs
fn main() {
    let mc91 = |mut f: &dyn Fn(i32) -> i32, n: i32| -> i32 {
        if n > 100 {
            n - 10
        } else {
            f(f(n + 11))
        }
    };

    // 再帰的クロージャには trick が必要（Yコンビネータ or 関数ポインタ）
    fn wrapper(n: i32) -> i32 {
        fn inner(n: i32) -> i32 {
            if n > 100 {
                n - 10
            } else {
                inner(inner(n + 11))
            }
        }
        inner(n)
    }

    for i in 85..=100 {
        println!("wrapper({}) = {}", i, wrapper(i));
    }
}
```

```
wrapper(85) = 91
wrapper(86) = 91
wrapper(87) = 91
wrapper(88) = 91
wrapper(89) = 91
wrapper(90) = 91
wrapper(91) = 91
wrapper(92) = 91
wrapper(93) = 91
wrapper(94) = 91
wrapper(95) = 91
wrapper(96) = 91
wrapper(97) = 91
wrapper(98) = 91
wrapper(99) = 91
wrapper(100) = 91
```
